<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGenesis - Verify & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --dark-bg: #010203; --primary-green: #22c55e; }
        body { font-family: 'Inter', sans-serif; background-color: var(--dark-bg); color: #e2e8f0; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(51, 65, 85, 0.5); }
        .btn-primary { background: var(--primary-green); transition: transform 0.2s; }
        .btn-primary:hover { transform: scale(1.05); }
        #upload-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 50; display: none; align-items: center; justify-content: center; }
        #upload-modal.flex { display: flex; }
    </style>
</head>
<body class="bg-dark-bg">

    <header class="fixed w-full z-50 p-4 border-b border-gray-800 bg-black bg-opacity-90">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-black text-white">Eco<span class="text-green-500">Genesis</span></div>
            <button id="wallet-btn" class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-white px-4 py-2 rounded transition">
                Connect Wallet
            </button>
        </div>
    </header>

    <section class="h-screen flex flex-col items-center justify-center text-center px-4 relative">
        <div class="z-10 max-w-4xl">
            <h1 class="text-6xl md:text-8xl font-black mb-6 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-emerald-600">
                Plant Trees.<br>Get Paid.
            </h1>
            <p class="text-xl text-gray-300 mb-8">Upload a photo. AI verifies it. You get ETH.</p>
            <button id="start-btn" class="btn-primary text-black font-bold text-xl px-10 py-4 rounded-full">
                Start Earning
            </button>
        </div>
    </section>

    <div id="upload-modal">
        <div class="glass-card p-8 rounded-2xl max-w-lg w-full m-4 relative">
            <button id="close-modal" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-white">&times;</button>
            <h2 class="text-3xl font-bold mb-2 text-white">Verify Planting</h2>
            
            <div id="drop-area" class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center cursor-pointer hover:border-green-500 transition mb-6">
                <input type="file" id="file-input" class="hidden" accept="image/*">
                <div id="preview-container"><p class="text-gray-400">Click to upload photo</p></div>
            </div>

            <div id="status-msg" class="text-center font-mono text-sm min-h-[20px] mb-4 text-green-400"></div>

            <button id="action-btn" class="w-full btn-primary text-black font-bold py-3 rounded-lg disabled:opacity-50" disabled>
                Submit
            </button>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "0xc329A783119E8b4219098C96493eb6783009601e"; 
        const BACKEND_URL = "/verify-planting";
        const CONTRACT_ABI = ["function claimReward(bytes memory signature) external"];

        let provider, signer, userAddress, selectedFile;

        const walletBtn = document.getElementById('wallet-btn');
        const startBtn = document.getElementById('start-btn');
        const modal = document.getElementById('upload-modal');
        const fileInput = document.getElementById('file-input');
        const actionBtn = document.getElementById('action-btn');
        const statusMsg = document.getElementById('status-msg');

        async function connectWallet() {
            if (!window.ethereum) return alert("Install MetaMask!");
            provider = new ethers.BrowserProvider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();
            
            const network = await provider.getNetwork();
            if (network.chainId !== 11155111n) {
                try { await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0xaa36a7" }] }); } 
                catch (e) { alert("Switch to Sepolia Testnet manually"); }
            }

            walletBtn.innerText = userAddress.slice(0,6) + "..." + userAddress.slice(-4);
            return true;
        }

        startBtn.addEventListener('click', async () => {
            if (!userAddress && !(await connectWallet())) return;
            modal.classList.add('flex');
        });

        document.getElementById('close-modal').addEventListener('click', () => modal.classList.remove('flex'));
        document.getElementById('drop-area').addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            selectedFile = e.target.files[0];
            if(selectedFile) {
                const reader = new FileReader();
                reader.onload = (e) => document.getElementById('preview-container').innerHTML = `<img src="${e.target.result}" class="h-32 mx-auto rounded">`;
                reader.readAsDataURL(selectedFile);
                actionBtn.disabled = false;
                actionBtn.innerText = "Submit for Verification";
            }
        });

        actionBtn.addEventListener('click', async () => {
            if (!selectedFile || !userAddress) return;
            
            actionBtn.disabled = true;
            actionBtn.innerText = "AI Verifying...";
            statusMsg.innerText = "Analyzing image...";
            statusMsg.className = "text-yellow-400 text-center mb-4";

            const formData = new FormData();
            formData.append('image', selectedFile);
            formData.append('address', userAddress);

            try {
                // 1. Backend Verification
                const res = await fetch(BACKEND_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (!data.success) throw new Error(data.message);

                // 2. Blockchain Claim
                statusMsg.innerText = "Verified! Please confirm in Wallet...";
                statusMsg.className = "text-green-400 text-center mb-4";
                
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const tx = await contract.claimReward(data.signature);
                
                statusMsg.innerText = "Transaction sent... Waiting...";
                await tx.wait();
                
                statusMsg.innerText = "SUCCESS! Reward Sent.";
                actionBtn.innerText = "Claimed!";
                
            } catch (err) {
                console.error(err);
                
                // --- THIS IS WHERE THE ERROR UI LOGIC GOES ---
                
                // 1. Check if User Rejected (cancelled) the transaction
                if (err.code === "ACTION_REJECTED" || err.code === 4001 || (err.message && err.message.includes("rejected"))) {
                    statusMsg.innerText = "Transaction Cancelled";
                    statusMsg.className = "text-yellow-400 text-center mb-4"; 
                    actionBtn.innerText = "Try Again";
                } 
                // 2. Check if Pool is Empty
                else if (err.message && err.message.includes("Contract is out of funds")) {
                    statusMsg.innerText = "Error: Reward Pool is Empty!";
                    statusMsg.className = "text-red-500 text-center mb-4";
                    actionBtn.innerText = "Pool Empty";
                }
                // 3. Other Errors
                else {
                    statusMsg.innerText = "Error: " + (err.reason || err.message || "Failed");
                    statusMsg.className = "text-red-500 text-center mb-4";
                    actionBtn.innerText = "Try Again";
                }
                
                actionBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
